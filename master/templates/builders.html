{% extends 'layout.html' %}
{% import 'forms.html' as forms %}
{% from "box_macros.html" import box %}

{% block content %}

<h1>hwmon:</h1>

<table border=1>
{% for b in builders if 'hwmon' in b.name %}
  <tr>
  <td class="box"><b><a href="{{ b.link }}">{{ b.name|e }}</a></b></td>
  <td>
  <table>
  <tr>
  {% if b.build_url and b.build_css_class %}
    <td class="LastBuild box {{ b.build_css_class }}">
        <a href="{{ b.build_url }}">{{ b.build_label }}</a>
        <br/> {{ b.build_text|replace('build successful', 'successful') }}
    </td>
  {% else %}
    <td class="LastBuild box">no build</td>
  {% endif %}  
  </tr>
  <tr> {{ box(**b.current_box) }}</tr>
  </table>
  </td>
  </tr>
{% endfor %}
</table>

<br>
<h1> stable queue: </h1>

{% set arches = [ "alpha", "arc", "arm", "arm64", "avr32", "blackfin",
		  "c6x", "cris", "frv", "hexagon", "i386", "ia64", "m32r", "m68k",
		  "m68k_nommu", "metag", "microblaze", "mips", "mn10300",
		  "openrisc",
		  "parisc", "parisc64", "powerpc", "s390", "sh", "sparc32",
		  "sparc64", "tile", "um", "x86_64", "xtensa" ] %}

{% set qemu_arches = [ "arm", "microblaze", "mips", "mips64", "ppc", "x86", "x86_64" ] %}

{% set releases = ["3.0", "3.2", "3.4", "3.10", "3.11", "master", "testing" ] %}

{% set exists = [] %}

<script type='text/javascript'>
{% for rel in releases %}
  {% set exists = [] %}
  var buildText_{{rel|replace('.','')}} = [
  {% for arch in arches %}
    {% set bname = "stable-queue-" ~ arch ~ "-" ~ rel %}
    {% for b in builders if b.name == bname %}
      {% if b.build_url and b.build_css_class %}
          {% if exists %} , {% endif %} "{{ b.build_text|replace('<br> ', '') }}"
          {% if exists.append("1") %} {% endif %}
      {% endif %}
    {% endfor %}
  {% endfor %} ];

  function getResults{{rel|replace('.','')}} (match_string)
  {
    var num = 0;
    for (var i=0; i < buildText_{{rel|replace('.','')}}.length; i++)
    {
        var elem = buildText_{{rel|replace('.','')}}[i];
	var m = match_string.exec(elem);
	if (m) {
	    var match = /\d+/;
	    num += parseInt(match.exec(m));
	}
    }
    return num;
  }
{% endfor %}
</script>

<table border=1>
<tr>
<th></th>
{% for rel in releases %}
    <th class="box">{{ rel }}</a></th>
{% endfor %}
</tr>

{% for arch in arches %}
  <tr>
  <td class="box"><b>{{ arch }}</b></a></td>
  {% for rel in releases %}
    {% set bname = "stable-queue-" ~ arch ~ "-" ~ rel %}
    <td class="LastBuild box">
    <table align=center>
    {% for b in builders if b.name == bname %}
      <tr>
      {% if b.build_url and b.build_css_class %}
        <td class="LastBuild box {{ b.build_css_class }}">
          <a href="{{ b.build_url }}">{{ b.build_label }}</a>
	  <br>
          {% if b.build_css_class == 'skipped' %}
            {{ b.build_text|replace('build successful', 'skipped') }}
	  {% else %}
            {{ b.build_text|replace('build successful', 'successful') }}
	  {% endif %}
        </td>
      {% else %}
        <td class="LastBuild box skipped">no build</td>
      {% endif %}
      </tr>
      <tr>
          {{ box(**b.current_box) }}
      </tr>
    {% else %}
        <tr><td class="LastBuild box skipped">skipped</td></tr>
    {% endfor %}
    </table>
    </td>
  {% endfor %}
  </tr>
{% endfor %}
  <tr>
  <td class="box"><b>Summary</b></a></td>
  {% for rel in releases %}
	<script type='text/javascript'>
	    var total = getResults{{rel|replace('.','')}} (/total: \d+/);
	    var passed = getResults{{rel|replace('.','')}} (/pass: \d+/);
	    var skipped = getResults{{rel|replace('.','')}} (/skipped: \d+/);
	    var fail = getResults{{rel|replace('.','')}} (/fail: \d+/);
	    var box = "success";
	    var build = "successful";
	    if (total == 0 || total == skipped) {
	    	box = "skipped";
	    	build = "skipped";
	    } else if (passed == 0) {
	    	box = "failure";
	    	build = "failed";
	    } else if (fail > 0) {
	    	box = "warnings";
	    	build = "warnings";
	    }
    	document.write('<td class="LastBuild box ' + box + '">\n');
	document.write(build + "<br>");
        document.write('total: ' + total +
			' pass: ' + passed +
			' skipped: ' + skipped +
			' fail: ' + fail);
        document.write('</td>\n');
	</script>
  {% endfor %}
  </tr>
</table>

<br>
<h1>qemu test results:</h1>

<table border=1>
<tr>
<th></th>
{% for rel in releases %}
    <th class="box">{{ rel }}</a></th>
{% endfor %}
</tr>

{% for arch in qemu_arches %}
  <tr>
  <td class="box"><b>{{ arch }}</b></a></td>
  {% for rel in releases %}
    {% set bname = "qemu-" ~ arch ~ "-" ~ rel %}
    <td class="LastBuild box">
    <table align=center>
    {% for b in builders if b.name == bname %}
      <tr>
      {% if b.build_url and b.build_css_class %}
        <td class="LastBuild box {{ b.build_css_class }}">
          <a href="{{ b.build_url }}">{{ b.build_label }}</a>
          <br> {{ b.build_text|replace('build successful', 'successful') }}
      {% else %}
        <td class="LastBuild box skipped">no build</td>
      {% endif %}
      </td>
      </tr>
      <tr>
          {{ box(**b.current_box) }}
      </tr>
    {% else %}
        <tr><td class="LastBuild box skipped">skipped</td></tr>
    {% endfor %}
    </table>
    </td>
  {% endfor %}
  </tr>
{% endfor %}

</table>

<br>
<h1> stable repository import: </h1>

<table>
{% for b in builders if b.name == "stable-updates" %}
  <tr>
  {% if b.build_url and b.build_css_class %}
    <td class="LastBuild box {{ b.build_css_class }}">
          <a href="{{ b.build_url }}">{{ b.build_label }}</a>
          <br/> {{ b.build_text|replace('build successful', 'successful') }}
    </td>
  {% else %}
    <td class="LastBuild box skipped">no build</td>
  {% endif %}
  </tr>
  <tr>
          {{ box(**b.current_box) }}
  </tr>
{% else %}
  <tr><td class="LastBuild box skipped">no build</td></tr>
{% endfor %}
</table>

<br>
<h1> stable queue import: </h1>

<table>
<tr>
{% for b in builders if b.name.startswith("stable-queue-import") %}
  <td>
  <table>
  <tr>
  {% if b.build_css_class %}
    <td class="LastBuild box {{ b.build_css_class }}">
          <a href="{{ b.build_url }}">{{ b.build_label }}</a>
	  <br/>{{b.name}}
          <br/> {{ b.build_text|replace('build successful', 'successful') }}
    </td>
  {% else %}
    <td class="LastBuild box skipped">no build</td>
  {% endif %}
  </tr>
  <tr>
          {{ box(**b.current_box) }}
  </tr>
  </table>
  </td>
{% else %}
  <td class="LastBuild box skipped">no build</td>
{% endfor %}
</tr>
</table>

<br>

{% if num_building > 0 %}
  {% if authz.advertiseAction('stopAllBuilds', request) or authz.advertiseAction('stopBuild', request) %}
    <h2>Stop Selected Builds</h2>
    {{ forms.stop_build(path_to_root+"builders/_selected/stopselected", authz, on_selected=True, builders=builders, label='Selected Builds') }}
    <h2>Stop All Builds</h2>
    {{ forms.stop_build(path_to_root+"builders/_all/stopall", authz, on_all=True, label='All Builds') }}
  {% endif %}
{% endif %}
  
{% if num_online > 0 %}
  {% if authz.advertiseAction('forceAllBuilds', request) or authz.advertiseAction('forceBuild', request) %}
    <h2>Force Selected Builds</h2>
    {{ forms.force_build(path_to_root+"builders/_selected/forceselected", authz, request, on_selected=True, builders=builders, force_schedulers=force_schedulers, default_props=default_props) }}
    <h2>Force All Builds</h2>
    {{ forms.force_build(path_to_root+"builders/_all/forceall", authz,request, on_all=True, force_schedulers=force_schedulers, default_props=default_props) }}
  {% endif %}
{% endif %}

{% endblock %}
